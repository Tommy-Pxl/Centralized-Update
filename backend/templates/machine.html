{% extends "base.html" %}
{% block content %}

<h2>
  Machine: {{ machine[1] }}
  <small class="text-muted">({{ machine[2] }})</small>
</h2>

<div class="mb-3">
  <a href="{{ url_for('scan', machine_id=machine[0]) }}" class="btn btn-primary btn-sm">
    Scan Now
  </a>
  <a href="{{ url_for('update', machine_id=machine[0]) }}" class="btn btn-warning btn-sm">
    Update Packages
  </a>
  <a href="{{ url_for('generate_enrollment_script') }}" class="btn btn-secondary btn-sm">
    Download Client Enrollment Script
  </a>
</div>

<hr>

<h4>Latest Scan</h4>
{% if latest_timestamp %}
<p class="text-muted">Last scan at: {{ latest_timestamp }} (UTC)</p>

{% if packages %}
<table class="table table-sm">
  <thead class="table-light">
    <tr>
      <th>Package</th>
      <th>Latest Version</th>
      <th>Installed Version</th>
    </tr>
  </thead>
  <tbody>
    {% for p in packages %}
    <tr>
      <td><code>{{ p.name }}</code></td>
      <td>{{ p.current }}</td>
      <td>{{ p.from or "-" }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">No upgradable packages found in the last scan.</p>
{% endif %}
{% else %}
<p class="text-muted">This machine has not been scanned yet.</p>
{% endif %}

<hr>

<h4>Scan History</h4>
{% if scans %}
<table class="table table-sm">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>Timestamp (UTC)</th>
    </tr>
  </thead>
  <tbody>
    {% for s in scans %}
    <tr>
      <td>{{ s[0] }}</td>
      <td>{{ s[1] }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">No scans recorded yet.</p>
{% endif %}

<hr>

<h4>Update History</h4>
{% if updates %}
<table class="table table-sm">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>Timestamp (UTC)</th>
      <th>Package</th>
      <th>Version (Status)</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for u in updates %}
    <tr>
      <td>{{ u[0] }}</td>
      <td>{{ u[1] }}</td>
      <td><code>{{ u[2] }}</code></td>
      <td>
        {{ u[3] }}
        {% if u[4] %}
          ({{ u[4] }})
        {% endif %}
      </td>
      <td>
        <a
          href="{{ url_for('downgrade_package', machine_id=machine[0], package=u[2]) }}"
          class="btn btn-outline-secondary btn-sm"
        >
          Downgrade
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p class="text-muted">No updates recorded yet.</p>
{% endif %}

{% endblock %}
