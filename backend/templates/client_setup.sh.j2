#!/bin/bash
#
# Client enrollment script for Centralized-Update
# Generated by the master at /generate_enrollment_script
#
# Usage on client:
#   curl http://{{ master_ip }}:5000/generate_enrollment_script -o client_setup.sh
#   sudo bash client_setup.sh
#

set -e

ANSIBLE_USER="ansible"
MASTER_IP="{{ master_ip }}"
MASTER_API="http://${MASTER_IP}:5000/api/enroll"

echo "==============================================="
echo "  Centralized-Update â€” Client Enrollment"
echo "==============================================="
echo "Master IP: ${MASTER_IP}"
echo "Ansible user: ${ANSIBLE_USER}"
echo

# ------------------------------------------------
# 1) Ensure ansible user exists
# ------------------------------------------------
if id "${ANSIBLE_USER}" &>/dev/null; then
    echo "[+] User '${ANSIBLE_USER}' already exists."
else
    echo "[+] Creating user '${ANSIBLE_USER}'..."
    useradd -m -s /bin/bash "${ANSIBLE_USER}"
fi

ANSIBLE_HOME=$(getent passwd "${ANSIBLE_USER}" | cut -d: -f6)
if [ -z "${ANSIBLE_HOME}" ]; then
    echo "[ERROR] Could not determine home directory for ${ANSIBLE_USER}."
    exit 1
fi

# ------------------------------------------------
# 2) Install master's SSH public key
# ------------------------------------------------
echo "[+] Configuring SSH authorized_keys for ${ANSIBLE_USER}..."

mkdir -p "${ANSIBLE_HOME}/.ssh"
chmod 700 "${ANSIBLE_HOME}/.ssh"

# Append the master's public key if not already present
AUTH_KEYS="${ANSIBLE_HOME}/.ssh/authorized_keys"
touch "${AUTH_KEYS}"

# The key we want to ensure is present:
MASTER_KEY="{{ ssh_public_key }}"

if grep -qxF "${MASTER_KEY}" "${AUTH_KEYS}" 2>/dev/null; then
    echo "    SSH key already present."
else
    echo "${MASTER_KEY}" >> "${AUTH_KEYS}"
    echo "    Added master's SSH key."
fi

chmod 600 "${AUTH_KEYS}"
chown -R "${ANSIBLE_USER}:${ANSIBLE_USER}" "${ANSIBLE_HOME}/.ssh"

# ------------------------------------------------
# 3) Grant passwordless sudo to ansible user
# ------------------------------------------------
echo "[+] Configuring passwordless sudo for ${ANSIBLE_USER}..."

SUDOERS_FILE="/etc/sudoers.d/${ANSIBLE_USER}"

cat > "${SUDOERS_FILE}" <<EOF
${ANSIBLE_USER} ALL=(ALL) NOPASSWD:ALL
EOF

chmod 440 "${SUDOERS_FILE}"

# Basic sanity check
if sudo -l -U "${ANSIBLE_USER}" 2>&1 | grep -q "NOPASSWD"; then
    echo "    Sudo configuration looks good."
else
    echo "    [WARNING] Could not verify sudo NOPASSWD for ${ANSIBLE_USER}."
fi

# ------------------------------------------------
# 4) Call back to master with hostname + IP
# ------------------------------------------------
echo "[+] Calling master enrollment API..."

HOSTNAME_SHORT=$(hostname -s)

# Allow override: CLIENT_IP=<ip> sudo bash client_setup.sh
if [ -n "${CLIENT_IP}" ]; then
    IP_ADDR="${CLIENT_IP}"
else
    # Use first non-loopback IPv4 address
    IP_ADDR=$(hostname -I 2>/dev/null | awk '{print $1}')
fi

if [ -z "${IP_ADDR}" ]; then
    echo "    [WARNING] Could not auto-detect IP address. Using 127.0.0.1."
    IP_ADDR="127.0.0.1"
fi

JSON_PAYLOAD=$(cat <<EOF
{
  "hostname": "${HOSTNAME_SHORT}",
  "ip": "${IP_ADDR}"
}
EOF
)

echo "    Hostname: ${HOSTNAME_SHORT}"
echo "    IP addr:  ${IP_ADDR}"
echo "    POST -> ${MASTER_API}"

curl -s -X POST "${MASTER_API}" \
  -H "Content-Type: application/json" \
  -d "${JSON_PAYLOAD}" \
  && echo "    Enrollment API call succeeded." \
  || echo "    [WARNING] Enrollment API call failed."

echo
echo "==============================================="
echo " Enrollment complete."
echo " - User:       ${ANSIBLE_USER}"
echo " - Hostname:   ${HOSTNAME_SHORT}"
echo " - Reported IP:${IP_ADDR}"
echo "==============================================="
