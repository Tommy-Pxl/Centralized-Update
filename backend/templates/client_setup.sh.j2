#!/bin/bash
set -e

ANSIBLE_USER="ansible"
MASTER_IP="{{ master_ip }}"
MASTER_API="http://${MASTER_IP}:5000/api/enroll"

echo "==============================================="
echo "  Centralized-Update â€” Client Enrollment"
echo "==============================================="
echo "Master IP: ${MASTER_IP}"
echo "Ansible user: ${ANSIBLE_USER}"
echo

# ------------------------------------------------
# 0) Ensure SSH server is installed and running
# ------------------------------------------------
echo "[+] Checking SSH server (OpenSSH)..."

SSH_SERVICE_OK=false

# Try to detect running ssh service via systemd
if command -v systemctl >/dev/null 2>&1; then
    if systemctl is-active --quiet ssh; then
        SSH_SERVICE_OK=true
        echo "    ssh service already active."
    fi
fi

if [ "${SSH_SERVICE_OK}" = false ]; then
    echo "[+] Installing and enabling OpenSSH server..."

    if command -v apt >/dev/null 2>&1; then
        # Install OpenSSH server if not present
        apt update -y
        apt install -y openssh-server

        # Enable + start ssh service via systemd if available
        if command -v systemctl >/dev/null 2>&1; then
            systemctl enable --now ssh || echo "    [WARNING] Could not enable/start ssh with systemctl."
        fi
    else
        echo "    [WARNING] 'apt' not found. Please install OpenSSH server and enable it manually."
    fi
fi

# Optional: open firewall for SSH if ufw is active
if command -v ufw >/dev/null 2>&1; then
    if ufw status 2>/dev/null | grep -q "Status: active"; then
        echo "[+] UFW is active, allowing SSH..."
        ufw allow OpenSSH 2>/dev/null || ufw allow 22/tcp 2>/dev/null || true
    fi
fi

echo

# ------------------------------------------------
# 1) Ensure ansible user exists
# ------------------------------------------------
echo "[+] Ensuring user '${ANSIBLE_USER}' exists..."

if id "${ANSIBLE_USER}" &>/dev/null; then
    echo "    User '${ANSIBLE_USER}' already exists."
else
    echo "    Creating user '${ANSIBLE_USER}'..."
    useradd -m -s /bin/bash "${ANSIBLE_USER}"
fi

ANSIBLE_HOME=$(getent passwd "${ANSIBLE_USER}" | cut -d: -f6)
if [ -z "${ANSIBLE_HOME}" ]; then
    echo "[ERROR] Could not determine home directory for ${ANSIBLE_USER}."
    exit 1
fi

# ------------------------------------------------
# 2) Install master's SSH public key
# ------------------------------------------------
echo "[+] Configuring SSH authorized_keys for ${ANSIBLE_USER}..."

mkdir -p "${ANSIBLE_HOME}/.ssh"
chmod 700 "${ANSIBLE_HOME}/.ssh"

AUTH_KEYS="${ANSIBLE_HOME}/.ssh/authorized_keys"
touch "${AUTH_KEYS}"

MASTER_KEY="{{ ssh_public_key }}"

if grep -qxF "${MASTER_KEY}" "${AUTH_KEYS}" 2>/dev/null; then
    echo "    Master's SSH key already present."
else
    echo "${MASTER_KEY}" >> "${AUTH_KEYS}"
    echo "    Added master's SSH key."
fi

chmod 600 "${AUTH_KEYS}"
chown -R "${ANSIBLE_USER}:${ANSIBLE_USER}" "${ANSIBLE_HOME}/.ssh"

echo

# ------------------------------------------------
# 3) Grant passwordless sudo to ansible user
# ------------------------------------------------
echo "[+] Configuring passwordless sudo for ${ANSIBLE_USER}..."

SUDOERS_FILE="/etc/sudoers.d/${ANSIBLE_USER}"

cat > "${SUDOERS_FILE}" <<EOF
${ANSIBLE_USER} ALL=(ALL) NOPASSWD:ALL
EOF

chmod 440 "${SUDOERS_FILE}"

if sudo -l -U "${ANSIBLE_USER}" 2>&1 | grep -q "NOPASSWD"; then
    echo "    Sudo configuration looks good."
else
    echo "    [WARNING] Could not verify sudo NOPASSWD for ${ANSIBLE_USER}."
fi

echo

# ------------------------------------------------
# 4) Call back to master with hostname + IP
# ------------------------------------------------
echo "[+] Calling master enrollment API..."

HOSTNAME_SHORT=$(hostname -s)

# Allow override: CLIENT_IP=<ip> sudo bash client_setup.sh
if [ -n "${CLIENT_IP}" ]; then
    IP_ADDR="${CLIENT_IP}"
else
    # Try to determine the IP address used for outbound traffic first
    # (works when the primary interface is not the first entry from hostname -I).
    IP_ADDR=""
    if command -v ip >/dev/null 2>&1; then
        IP_ADDR=$(ip route get 8.8.8.8 2>/dev/null | awk '{for(i=1;i<=NF;i++) if ($i=="src") print $(i+1)}' | head -n1)
    fi

    # Fallback to hostname -I if ip route didn't work
    if [ -z "${IP_ADDR}" ]; then
        IP_ADDR=$(hostname -I 2>/dev/null | awk '{print $1}')
    fi
fi

if [ -z "${IP_ADDR}" ]; then
    echo "    [WARNING] Could not auto-detect IP address. Using 127.0.0.1."
    IP_ADDR="127.0.0.1"
fi

JSON_PAYLOAD=$(cat <<EOF
{
  "hostname": "${HOSTNAME_SHORT}",
  "ip": "${IP_ADDR}"
}
EOF
)

echo "    Hostname: ${HOSTNAME_SHORT}"
echo "    IP addr:  ${IP_ADDR}"
echo "    POST -> ${MASTER_API}"

if command -v curl >/dev/null 2>&1; then
    curl -s -X POST "${MASTER_API}" \
      -H "Content-Type: application/json" \
      -d "${JSON_PAYLOAD}" \
      && echo "    Enrollment API call succeeded." \
      || echo "    [WARNING] Enrollment API call failed."
else
    echo "    [WARNING] 'curl' not found, please POST this JSON manually:"
    echo "${JSON_PAYLOAD}"
fi

echo
echo "==============================================="
echo " Enrollment complete."
echo " - User:       ${ANSIBLE_USER}"
echo " - Hostname:   ${HOSTNAME_SHORT}"
echo " - Reported IP:${IP_ADDR}"
echo "==============================================="
