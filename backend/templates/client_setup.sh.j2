#!/bin/bash
set -e

MASTER_IP="{{ master_ip }}"
MASTER_SSH_KEY="{{ ssh_public_key }}"
ANSIBLE_USER="{{ ansible_user }}"
HOSTNAME="{{ hostname }}"

echo "========================================================="
echo " Centralized-Update Client Setup"
echo "========================================================="

sudo apt update -y
sudo apt install -y openssh-server python3 sudo curl

echo "[+] Creating ansible user..."
sudo useradd -m -s /bin/bash "$ANSIBLE_USER" || true
echo "$ANSIBLE_USER ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$ANSIBLE_USER

sudo mkdir -p /home/$ANSIBLE_USER/.ssh
echo "$MASTER_SSH_KEY" | sudo tee /home/$ANSIBLE_USER/.ssh/authorized_keys
sudo chmod 600 /home/$ANSIBLE_USER/.ssh/authorized_keys
sudo chown -R $ANSIBLE_USER:$ANSIBLE_USER /home/$ANSIBLE_USER/.ssh

sudo systemctl enable ssh || true
sudo systemctl start ssh || true

sudo hostnamectl set-hostname "$HOSTNAME"

IP_ADDR=$(hostname -I | awk '{print $1}')

curl -X POST "http://$MASTER_IP:5000/api/enroll" \
    -H "Content-Type: application/json" \
    -d "{\"hostname\": \"$HOSTNAME\", \"ip\": \"$IP_ADDR\"}"

echo "========================================================="
echo " Client is now enrolled."
echo "========================================================="
